pipeline {
    agent any
    
    environment {
        // T√™n image v√† container
        IMAGE_NAME = 'itworks-backend'
        CONTAINER_NAME = 'itworks-backend'
        
        // Port mapping
        APP_PORT = '3000'
        HOST_PORT = '3000'
        
        // Credentials ID cho .env file (t·∫°o trong Jenkins Credentials)
        ENV_FILE_CREDENTIAL_ID = 'backend-env-file'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Load Environment File') {
            steps {
                script {
                    echo 'üìù Loading .env file from Jenkins credentials...'
                    dir('backend') {
                        // Load .env file t·ª´ Jenkins credentials
                        withCredentials([file(credentialsId: env.ENV_FILE_CREDENTIAL_ID, variable: 'ENV_FILE')]) {
                            sh """
                                cp ${ENV_FILE} .env
                                echo "‚úÖ .env file loaded"
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo 'üî® Building Docker image...'
                    dir('backend') {
                        // Build image v·ªõi tag
                        def imageTag = "${IMAGE_NAME}:${BUILD_NUMBER}"
                        def imageLatest = "${IMAGE_NAME}:latest"
                        
                        sh """
                            docker build -t ${imageTag} -t ${imageLatest} .
                        """
                        
                        echo "‚úÖ Image built: ${imageTag}"
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo 'üß™ Running tests...'
                    dir('backend') {
                        // Ch·∫°y tests trong container (optional)
                        // sh 'docker run --rm ${IMAGE_NAME}:${BUILD_NUMBER} npm test'
                        echo '‚ö†Ô∏è  Tests skipped (uncomment to enable)'
                    }
                }
            }
        }
        
        stage('Stop Old Container') {
            steps {
                script {
                    echo 'üõë Stopping old container if exists...'
                    sh """
                        docker stop ${CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} || true
                    """
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    echo 'üöÄ Deploying new container...'
                    dir('backend') {
                        // Ch·∫°y container v·ªõi .env ƒë√£ ƒë∆∞·ª£c load
                        sh """
                            docker run -d \\
                                --name ${CONTAINER_NAME} \\
                                --restart unless-stopped \\
                                -p ${HOST_PORT}:${APP_PORT} \\
                                --env-file .env \\
                                ${IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'üè• Waiting for application to start...'
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // Ki·ªÉm tra container c√≥ ch·∫°y kh√¥ng
                    sh """
                        if docker ps | grep -q ${CONTAINER_NAME}; then
                            echo "‚úÖ Container is running"
                        else
                            echo "‚ùå Container failed to start"
                            docker logs ${CONTAINER_NAME} || true
                            exit 1
                        fi
                    """
                    
                    // Ki·ªÉm tra health endpoint (n·∫øu c√≥)
                    sh """
                        sleep 5
                        curl -f http://localhost:${HOST_PORT}/health || echo "‚ö†Ô∏è  Health check endpoint not available"
                    """
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo 'üßπ Cleaning up old images...'
                    // X√≥a images c≈© (gi·ªØ l·∫°i 5 images g·∫ßn nh·∫•t)
                    sh """
                        docker images ${IMAGE_NAME} --format '{{.ID}} {{.Tag}}' | \\
                        grep -v latest | \\
                        sort -k2 -n -r | \\
                        tail -n +6 | \\
                        awk '{print \$1}' | \\
                        xargs -r docker rmi || true
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            // C√≥ th·ªÉ th√™m notification ·ªü ƒë√¢y (email, Slack, etc.)
        }
        failure {
            echo '‚ùå Pipeline failed!'
            script {
                // Log container logs n·∫øu fail
                sh """
                    docker logs ${CONTAINER_NAME} || true
                """
            }
        }
        always {
            echo 'üìã Pipeline finished'
            // Cleanup .env file sau khi deploy (optional, ƒë·ªÉ b·∫£o m·∫≠t)
            script {
                sh """
                    rm -f backend/.env || true
                """
            }
        }
    }
}

