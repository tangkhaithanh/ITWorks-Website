// Generator & datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===============================
// 1. Accounts
// ===============================
model Account {
  id         BigInt   @id @default(autoincrement())
  email      String   @unique
  password   String
  role       Role
  status     Status   @default(active)
  refreshToken String?
  must_change_password Boolean @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user          User?
  company       Company?
  notifications Notification[]
  admin_logs    AdminLog[]
}

enum Role {
  candidate
  recruiter
  admin
}

enum Status {
  active
  banned
  pending
}

// ===============================
// 2. Users
// ===============================
model User {
  id         BigInt    @id @default(autoincrement())
  account_id BigInt    @unique
  full_name  String
  phone      String?
  dob        DateTime?
  gender     Gender?
  address    String?
  avatar_url String?
  avatar_public_id String?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  account   Account    @relation(fields: [account_id], references: [id])
  candidate Candidate?
}

enum Gender {
  male
  female
  other
}

// ===============================
// 3. Candidates
// ===============================
model Candidate {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt   @unique
  
  // Preferences for matching (optional nh∆∞ng r·∫•t c√≥ √≠ch)
  preferred_city      String?
  preferred_work_mode WorkMode?
  preferred_category  BigInt?
  preferred_salary    Float?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user         User             @relation(fields: [user_id], references: [id])
  cvs          Cv[]
  applications Application[]
  saved_jobs   SavedJob[]
  skills       CandidateSkill[]
}

// ===============================
// 4. Companies
// ===============================
model Industry {
  id        BigInt    @id @default(autoincrement())
  name      String    @unique
  companies CompanyIndustry[]
}

model Company {
  id             BigInt   @id @default(autoincrement())
  account_id     BigInt   @unique

  // Profile
  name           String
  logo_url       String?
  logo_public_id String?
  website        String?
  description    String? @db.LongText

  // Location & Size
  headquarters   String?
  address        String?
  size           CompanySize?

  // Skills & Industries
  industry_info  CompanyIndustry[]
  skills         CompanySkill[]

  // Legal
  business_code           String? @unique
  representative_name     String?
  representative_position String?
  license_file_url        String?
  license_file_public_id  String?

  // Contact
  contact_email  String?
  contact_phone  String?

  // Other
  founded_date   DateTime?
  status         CompanyStatus @default(pending)
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  // Relations
  account    Account  @relation(fields: [account_id], references: [id])
  jobs       Job[]
  statistics RecruiterStatistic[]
  companyPlan        CompanyPlan?
  companyPlanHistory CompanyPlanHistory[]
  paymentOrders      PaymentOrder[]
  jobBoosts          JobBoost[]
  creditTransactions CreditTransaction[]
}


model CompanySkill {
  id          BigInt @id @default(autoincrement())
  company_id  BigInt
  skill_id    BigInt

  company Company @relation(fields: [company_id], references: [id])
  skill   Skill   @relation(fields: [skill_id], references: [id])

  @@unique([company_id, skill_id])
}

model CompanyIndustry {
  id          BigInt   @id @default(autoincrement())
  company_id  BigInt
  industry_id BigInt

  company  Company  @relation(fields: [company_id], references: [id])
  industry Industry @relation(fields: [industry_id], references: [id])

  @@unique([company_id, industry_id])
}

enum CompanySize {
  small
  medium
  large
}

enum CompanyStatus {
  pending
  approved
  rejected
  hidden
}

// ===============================
// 5. Jobs
// ===============================
model Job {
  id                 BigInt           @id @default(autoincrement())
  company_id         BigInt
  category_id        BigInt
  title              String
  salary_min         Float?
  salary_max         Float?
  negotiable         Boolean          @default(false)

  // üó∫Ô∏è Th√¥ng tin ƒë·ªãa ƒëi·ªÉm
  location_city      String           // TP.HCM
  location_district  String?          // Qu·∫≠n 1
  location_ward      String?          // Ph∆∞·ªùng ƒêa Kao
  location_street    String?          // 29 Nguy·ªÖn ƒê√¨nh Chi·ªÉu
  location_full      String?          // Gh√©p t·ª± ƒë·ªông: "29 Nguy·ªÖn ƒê√¨nh Chi·ªÉu, Ph∆∞·ªùng ƒêa Kao, Qu·∫≠n 1, TP.HCM"
  latitude           Float?           // 10.7769
  longitude          Float?           // 106.7009

  // üíº H√¨nh th·ª©c & c·∫•p ƒë·ªô l√†m vi·ªác
  work_modes         Json            // V√≠ d·ª•: ["onsite", "remote"]
  experience_levels  Json            // V√≠ d·ª•: ["junior", "mid"]

  // üßæ Lo·∫°i vi·ªác & tr·∫°ng th√°i
  employment_type    EmploymentType
  status             JobStatus        @default(active)
  deadline           DateTime?
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt

  // Th√¥ng tin th·ªëng k√™
  number_of_openings Int               @default(1)   // S·ªë l∆∞·ª£ng c·∫ßn tuy·ªÉn
  views_count        Int               @default(0)   // T·ªïng l∆∞·ª£t xem job

  // üîó Quan h·ªá
  company      Company       @relation(fields: [company_id], references: [id])
  category     JobCategory?  @relation(fields: [category_id], references: [id])
  details      JobDetail?
  applications Application[]
  saved_jobs   SavedJob[]
  skills       JobSkill[]
  boosts       JobBoost[]
  creditTransactions CreditTransaction[]
}

model JobDetail {
  job_id       BigInt   @id
  description  String?  @db.LongText
  requirements String?  @db.LongText
  job          Job      @relation(fields: [job_id], references: [id])
}

model Skill {
  id         BigInt           @id @default(autoincrement())
  name       String           @unique
  jobs       JobSkill[]
  candidates CandidateSkill[]
  company_skills CompanySkill[]   // th√™m d√≤ng n√†y
}

model JobSkill {
  id       BigInt @id @default(autoincrement())
  job_id   BigInt
  skill_id BigInt

  job   Job   @relation(fields: [job_id], references: [id])
  skill Skill @relation(fields: [skill_id], references: [id])
}

enum EmploymentType {
  fulltime
  parttime
  intern
  contract
}

enum JobStatus {
  active
  hidden
  closed
  expired
}

enum WorkMode {
  onsite
  remote
  hybrid
}

enum ExperienceLevel {
  fresher
  junior
  mid
  senior
  lead
  intern
}


model CandidateSkill {
  id           BigInt      @id @default(autoincrement())
  candidate_id BigInt
  skill_id     BigInt

  candidate Candidate @relation(fields: [candidate_id], references: [id])
  skill     Skill     @relation(fields: [skill_id], references: [id])
}

// ===============================
// 6. Job Categories
// ===============================
model JobCategory {
  id   BigInt @id @default(autoincrement())
  name String @unique
  jobs Job[]
}

// ===============================
// 7. CVs
// ===============================
model Cv {
  id           BigInt   @id @default(autoincrement())
  candidate_id BigInt
  title        String
  file_url     String?
  file_public_id  String?
  template_id  BigInt?
  content      Json?
  type         CvType   @default(ONLINE)
  is_deleted   Boolean  @default(false)  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  candidate    Candidate     @relation(fields: [candidate_id], references: [id])
  template     CvTemplate?   @relation(fields: [template_id], references: [id])
  applications Application[]
}
enum CvType {
  FILE
  ONLINE
}


// ===============================
// 8. CV Templates
// ===============================
model CvTemplate {
  id          BigInt   @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  preview_url String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  cvs Cv[]
}

// ===============================
// 9. Applications
// ===============================
model Application {
  id           BigInt            @id @default(autoincrement())
  job_id       BigInt
  candidate_id BigInt
  cv_id        BigInt
  status       ApplicationStatus @default(pending)
  applied_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt

  job       Job       @relation(fields: [job_id], references: [id])
  candidate Candidate @relation(fields: [candidate_id], references: [id])
  cv        Cv        @relation(fields: [cv_id], references: [id])
  interviews Interview[]
}

enum ApplicationStatus {
  pending
  interviewing
  accepted
  rejected
  withdrawn
}

// ===============================
// 10. Saved Jobs
// ===============================
model SavedJob {
  id           BigInt   @id @default(autoincrement())
  candidate_id BigInt
  job_id       BigInt
  saved_at     DateTime @default(now())
  updated_at   DateTime @updatedAt

  candidate Candidate @relation(fields: [candidate_id], references: [id])
  job       Job       @relation(fields: [job_id], references: [id])
}

// ===============================
// 11. Notifications
// ===============================
model Notification {
  id         BigInt           @id @default(autoincrement())
  account_id BigInt
  type       NotificationType
  message    String
  is_read    Boolean          @default(false)
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt

  account Account @relation(fields: [account_id], references: [id])
}

enum NotificationType {
  system
  application
  company
}

// ===============================
// 12. Admin Logs
// ===============================
model AdminLog {
  id          BigInt     @id @default(autoincrement())
  admin_id    BigInt
  action      String
  target_type TargetType
  target_id   BigInt?
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  admin Account @relation(fields: [admin_id], references: [id])
}

enum TargetType {
  user
  company
  job
}

// ===============================
// 13. Site Statistics
// ===============================
model SiteStatistic {
  id         BigInt   @id @default(autoincrement())
  metric     String
  value      Int
  date       DateTime
  updated_at DateTime @updatedAt
}

// ===============================
// 14. Recruiter Statistics
// ===============================
model RecruiterStatistic {
  id         BigInt   @id @default(autoincrement())
  company_id BigInt
  metric     String
  value      Int
  date       DateTime
  updated_at DateTime @updatedAt

  company Company @relation(fields: [company_id], references: [id])
}
// ===============================
// 15. Interviews
// ===============================
model Interview {
  id              BigInt           @id @default(autoincrement())
  application_id  BigInt
  scheduled_at    DateTime
  mode            InterviewMode
  location        String?
  meeting_link    String?
  status          InterviewStatus  @default(scheduled)
  notes           String?
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  application Application @relation(fields: [application_id], references: [id])
}

enum InterviewStatus {
  scheduled
  rescheduled
  cancelled
  completed
}

enum InterviewMode {
  online
  offline
}
// 16. Plans:
model Plan {
  id             BigInt  @id @default(autoincrement())
  name           String
  price          BigInt
  job_limit      Int
  credit_amount  Int
  duration_days  Int
  features       String? @db.LongText

  is_hidden      Boolean @default(false)

  companyPlans   CompanyPlan[]
  histories      CompanyPlanHistory[]
  paymentOrders  PaymentOrder[]
  creditTransactions CreditTransaction[]

  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
}

// CompanyPlan:
model CompanyPlan {
  id            BigInt   @id @default(autoincrement())
  company_id    BigInt   @unique
  plan_id       BigInt

  // th·ªùi gian hi·ªáu l·ª±c c·ªßa "bucket current"
  start_date    DateTime
  end_date      DateTime

  // SNAPSHOT t·∫°i th·ªùi ƒëi·ªÉm mua (kh√¥ng ph·ª• thu·ªôc Plan b·ªã s·ª≠a sau n√†y)
  purchased_price        BigInt
  job_limit_snapshot     Int
  credit_amount_snapshot Int

  // usage
  jobs_left     Int
  order_id      BigInt? @unique
  credits_left  Int

  status        PlanStatus @default(active)

  company Company @relation(fields: [company_id], references: [id])
  plan    Plan    @relation(fields: [plan_id], references: [id])
  order    PaymentOrder? @relation(fields: [order_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([company_id, status, end_date])
}


enum PlanStatus {
  active
  expired
  cancelled
}
// Company Plan History
model CompanyPlanHistory {
  id              BigInt   @id @default(autoincrement())
  company_id      BigInt
  plan_id         BigInt

  // SNAPSHOT t·∫°i th·ªùi ƒëi·ªÉm mua / l√∫c bucket ƒë∆∞·ª£c t·∫°o
  purchased_price        BigInt
  job_limit_snapshot     Int
  credit_amount_snapshot Int

  start_date      DateTime
  end_date        DateTime

  // usage
  jobs_used       Int
  credits_used    Int

  status          PlanHistoryStatus
  order_id        BigInt?

  company Company @relation(fields: [company_id], references: [id])
  plan    Plan    @relation(fields: [plan_id], references: [id])
  order   PaymentOrder? @relation(fields: [order_id], references: [id])

  created_at DateTime @default(now())

  @@index([company_id, status, end_date, created_at])
}


enum PlanHistoryStatus {
  completed
  expired
  cancelled
}

// Payment order- ph·ª•c v·ª• cho trang checkout:
model PaymentOrder {
  id              BigInt   @id @default(autoincrement())
  company_id      BigInt
  plan_id         BigInt

  amount          BigInt
  payment_method  PaymentMethod @default(vnpay)

  status          PaymentStatus  @default(pending)

  vnp_txn_ref     String?        // vnp_TxnRef
  vnp_transaction_no String?     // m√£ GD VNPAY
  vnp_response_code String?

  paid_at         DateTime?
  expired_at      DateTime?

  company Company @relation(fields: [company_id], references: [id])
  plan    Plan    @relation(fields: [plan_id], references: [id])
  histories CompanyPlanHistory[]
  companyPlan       CompanyPlan?
  creditTransactions CreditTransaction[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

enum PaymentStatus {
  pending
  paid
  failed
  cancelled
  expired
}

enum PaymentMethod {
  vnpay
}
// Boost Job rule:
model BoostRule {
  id        BigInt @id @default(autoincrement())
  tier      BoostTier
  credits   Int
  duration_days Int

  created_at DateTime @default(now())
}

enum BoostTier {
  top_100
  top_50
  top_30
  top_10
}
// Job boost history:
model JobBoost {
  id         BigInt @id @default(autoincrement())
  job_id     BigInt
  company_id BigInt

  tier       BoostTier
  credits    Int

  start_at   DateTime
  end_at     DateTime
  status     BoostStatus @default(active)

  job     Job     @relation(fields: [job_id], references: [id])
  company Company @relation(fields: [company_id], references: [id])

  created_at DateTime @default(now())
}

enum BoostStatus {
  active
  expired
  cancelled
}

// CREDIT TRANSACTION - log c·ªông tr·ª´ / c·ªông redit:
model CreditTransaction {
  id          BigInt @id @default(autoincrement())
  company_id  BigInt

  amount      Int              // + ho·∫∑c -
  type        CreditTxnType
  job_id      BigInt?
  order_id    BigInt?
  plan_id     BigInt?

  created_at  DateTime @default(now())

  company Company @relation(fields: [company_id], references: [id])
  order   PaymentOrder? @relation(fields: [order_id], references: [id])
  plan    Plan?         @relation(fields: [plan_id], references: [id])
  job     Job?          @relation(fields: [job_id], references: [id])
}

enum CreditTxnType {
  grant       // c·∫•p khi mua plan
  boost       // tr·ª´ khi boost job
  refund
}
// Location:
model LocationCity {
  id     Int            @id
  name   String

  wards  LocationWard[]
}

model LocationWard {
  id      Int    @id
  name    String

  city_id Int
  city    LocationCity @relation(fields: [city_id], references: [id], onDelete: Cascade)
}



