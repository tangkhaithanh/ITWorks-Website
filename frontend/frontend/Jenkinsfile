pipeline {
    agent any
    
    environment {
        // T√™n image v√† container
        IMAGE_NAME = 'itworks-frontend'
        CONTAINER_NAME = 'itworks-frontend'
        NGINX_IMAGE_NAME = 'itworks-nginx'
        NGINX_CONTAINER_NAME = 'itworks-nginx'
        DOCKER_NETWORK = 'itworks-network'
        
        // Port mapping
        APP_PORT = '80'
        NGINX_HTTP_PORT = '80'
        NGINX_HTTPS_PORT = '443'
        
        // SSL Configuration
        SSL_ENABLED = 'true'  // Set 'false' ƒë·ªÉ disable SSL
        DOMAIN = 'itworks.dpdns.org'
        DOMAIN_EMAIL = 'admin@itworks.dpdns.org'  // Email cho Let's Encrypt
        SSL_CERT_PATH = '/etc/letsencrypt'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Create Docker Network') {
            steps {
                script {
                    echo 'üåê Creating Docker network...'
                    sh """
                        docker network create ${DOCKER_NETWORK} 2>/dev/null || true
                    """
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo 'üî® Building Frontend Docker image...'
                    dir('frontend/frontend') {
                        // Build frontend image v·ªõi tag
                        def imageTag = "${IMAGE_NAME}:${BUILD_NUMBER}"
                        def imageLatest = "${IMAGE_NAME}:latest"
                        
                        sh """
                            docker build -t ${imageTag} -t ${imageLatest} .
                        """
                        
                        echo "‚úÖ Frontend image built: ${imageTag}"
                    }
                }
            }
        }
        
        stage('Setup SSL Certificates') {
            when {
                expression { return SSL_ENABLED == 'true' }
            }
            steps {
                script {
                    echo 'üîí Setting up SSL certificates...'
                    
                    // Ki·ªÉm tra xem certificates ƒë√£ t·ªìn t·∫°i ch∆∞a
                    def certExists = sh(
                        script: """
                            test -f ${SSL_CERT_PATH}/live/${DOMAIN}/fullchain.pem && \\
                            test -f ${SSL_CERT_PATH}/live/${DOMAIN}/privkey.pem
                        """,
                        returnStatus: true
                    ) == 0
                    
                    if (!certExists) {
                        echo "üìú SSL certificates ch∆∞a t·ªìn t·∫°i, ƒëang t·∫°o m·ªõi..."
                        
                        // C√†i ƒë·∫∑t certbot n·∫øu ch∆∞a c√≥
                        sh """
                            which certbot || (apt-get update && apt-get install -y certbot)
                        """
                        
                        // T·∫°o th∆∞ m·ª•c cho certificates
                        sh """
                            mkdir -p ${SSL_CERT_PATH}/live/${DOMAIN}
                            mkdir -p /var/www/certbot
                        """
                        
                        // T·∫°m th·ªùi stop nginx container n·∫øu ƒëang ch·∫°y ƒë·ªÉ certbot c√≥ th·ªÉ d√πng port 80
                        sh """
                            docker stop ${NGINX_CONTAINER_NAME} || true
                        """
                        
                        // L·∫•y SSL certificate t·ª´ Let's Encrypt v·ªõi sudo v√† set c√°c th∆∞ m·ª•c c√≥ th·ªÉ ghi ƒë∆∞·ª£c
                        def certResult = sh(
                            script: """
                                sudo certbot certonly --standalone \\
                                    -d ${DOMAIN} \\
                                    -d www.${DOMAIN} \\
                                    --non-interactive \\
                                    --agree-tos \\
                                    --email ${DOMAIN_EMAIL} \\
                                    --preferred-challenges http \\
                                    --config-dir ${SSL_CERT_PATH} \\
                                    --work-dir /tmp/letsencrypt-work \\
                                    --logs-dir /tmp/letsencrypt-logs || true
                            """,
                            returnStatus: true
                        )
                        
                        if (certResult != 0) {
                            echo "‚ö†Ô∏è  Kh√¥ng th·ªÉ t·∫°o SSL certificate t·ª± ƒë·ªông"
                            echo "‚ö†Ô∏è  C√≥ th·ªÉ do domain ch∆∞a tr·ªè v·ªÅ IP, port 80 ƒëang b·ªã chi·∫øm, ho·∫∑c thi·∫øu quy·ªÅn sudo"
                            echo "‚ö†Ô∏è  Vui l√≤ng setup SSL th·ªß c√¥ng ho·∫∑c disable SSL_ENABLED"
                            echo "‚ö†Ô∏è  Pipeline s·∫Ω ti·∫øp t·ª•c nh∆∞ng SSL c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông"
                        } else {
                            echo "‚úÖ SSL certificates ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng"
                        }
                    } else {
                        echo "‚úÖ SSL certificates ƒë√£ t·ªìn t·∫°i"
                        
                        // Renew certificate n·∫øu s·∫Øp h·∫øt h·∫°n (trong v√≤ng 30 ng√†y)
                        sh """
                            sudo certbot renew --quiet --no-random-sleep-on-renew \\
                                --config-dir ${SSL_CERT_PATH} \\
                                --work-dir /tmp/letsencrypt-work \\
                                --logs-dir /tmp/letsencrypt-logs || true
                        """
                    }
                }
            }
        }
        
        stage('Build Nginx Image') {
            steps {
                script {
                    echo 'üî® Building Nginx reverse proxy image...'
                    dir('frontend/frontend/nginx') {
                        // Build nginx image v·ªõi tag
                        def nginxImageTag = "${NGINX_IMAGE_NAME}:${BUILD_NUMBER}"
                        def nginxImageLatest = "${NGINX_IMAGE_NAME}:latest"
                        
                        // N·∫øu SSL enabled, t·∫°o nginx.conf v·ªõi SSL
                        if (SSL_ENABLED == 'true') {
                            echo "üîí Creating Nginx config with SSL..."
                            sh """
                                # Uncomment HTTPS server block
                                sed -i 's/# server {/server {/g' nginx.conf
                                sed -i 's/#     listen 443/    listen 443/g' nginx.conf
                                sed -i 's/#     server_name/    server_name/g' nginx.conf
                                sed -i 's/#     ssl_certificate/    ssl_certificate/g' nginx.conf
                                sed -i 's/#     ssl_certificate_key/    ssl_certificate_key/g' nginx.conf
                                sed -i 's/#     ssl_protocols/    ssl_protocols/g' nginx.conf
                                sed -i 's/#     ssl_ciphers/    ssl_ciphers/g' nginx.conf
                                sed -i 's/#     ssl_prefer_server_ciphers/    ssl_prefer_server_ciphers/g' nginx.conf
                                sed -i 's/#     ssl_session_cache/    ssl_session_cache/g' nginx.conf
                                sed -i 's/#     ssl_session_timeout/    ssl_session_timeout/g' nginx.conf
                                sed -i 's/#     add_header/    add_header/g' nginx.conf
                                sed -i 's/#     gzip/    gzip/g' nginx.conf
                                sed -i 's/#     proxy_set_header/    proxy_set_header/g' nginx.conf
                                sed -i 's/#     proxy_connect_timeout/    proxy_connect_timeout/g' nginx.conf
                                sed -i 's/#     proxy_send_timeout/    proxy_send_timeout/g' nginx.conf
                                sed -i 's/#     proxy_read_timeout/    proxy_read_timeout/g' nginx.conf
                                sed -i 's/#     location/    location/g' nginx.conf
                                sed -i 's/#         proxy_pass/        proxy_pass/g' nginx.conf
                                sed -i 's/#         proxy_http_version/        proxy_http_version/g' nginx.conf
                                sed -i 's/#         proxy_set_header/        proxy_set_header/g' nginx.conf
                                sed -i 's/#         expires/        expires/g' nginx.conf
                                sed -i 's/#         add_header/        add_header/g' nginx.conf
                                sed -i 's/# }/}/g' nginx.conf
                                
                                # Enable HTTP to HTTPS redirect
                                sed -i 's/# return 301 https/return 301 https/g' nginx.conf
                            """
                        }
                        
                        sh """
                            docker build -t ${nginxImageTag} -t ${nginxImageLatest} .
                        """
                        
                        echo "‚úÖ Nginx image built: ${nginxImageTag}"
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo 'üß™ Running tests...'
                    dir('frontend/frontend') {
                        // Ch·∫°y tests trong container (optional)
                        // sh 'docker run --rm ${IMAGE_NAME}:${BUILD_NUMBER} npm test'
                        echo '‚ö†Ô∏è  Tests skipped (uncomment to enable)'
                    }
                }
            }
        }
        
        stage('Stop Old Containers') {
            steps {
                script {
                    echo 'üõë Stopping old containers if exists...'
                    sh """
                        docker stop ${CONTAINER_NAME} ${NGINX_CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} ${NGINX_CONTAINER_NAME} || true
                    """
                }
            }
        }
        
        stage('Deploy Frontend') {
            steps {
                script {
                    echo 'üöÄ Deploying Frontend container...'
                    // Frontend kh√¥ng c·∫ßn expose port ra ngo√†i, ch·ªâ c·∫ßn trong Docker network
                    // Nginx s·∫Ω proxy ƒë·∫øn container n√†y
                    sh """
                        docker run -d \\
                            --name ${CONTAINER_NAME} \\
                            --restart unless-stopped \\
                            --network ${DOCKER_NETWORK} \\
                            ${IMAGE_NAME}:${BUILD_NUMBER}
                    """
                }
            }
        }
        
        stage('Deploy Nginx') {
            steps {
                script {
                    echo 'üöÄ Deploying Nginx reverse proxy container...'
                    
                    // Build docker run command v·ªõi SSL mount n·∫øu enabled
                    def dockerRunArgs = [
                        'docker', 'run', '-d',
                        '--name', "${NGINX_CONTAINER_NAME}",
                        '--restart', 'unless-stopped',
                        '-p', "${NGINX_HTTP_PORT}:80",
                        '-p', "${NGINX_HTTPS_PORT}:443",
                        '--network', "${DOCKER_NETWORK}"
                    ]
                    
                    // Mount SSL certificates n·∫øu SSL enabled
                    if (SSL_ENABLED == 'true') {
                        dockerRunArgs.addAll([
                            '-v', "${SSL_CERT_PATH}:/etc/letsencrypt:ro",
                            '-v', '/var/www/certbot:/var/www/certbot:ro'
                        ])
                        echo "üîí Mounting SSL certificates from ${SSL_CERT_PATH}"
                    }
                    
                    // Th√™m image name
                    dockerRunArgs.add("${NGINX_IMAGE_NAME}:${BUILD_NUMBER}")
                    
                    // Ch·∫°y command
                    sh dockerRunArgs.join(' ')
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'üè• Waiting for application to start...'
                    sleep(time: 5, unit: 'SECONDS')
                    
                    // Ki·ªÉm tra container c√≥ ch·∫°y kh√¥ng
                    sh """
                        if docker ps | grep -q ${CONTAINER_NAME}; then
                            echo "‚úÖ Container is running"
                        else
                            echo "‚ùå Container failed to start"
                            docker logs ${CONTAINER_NAME}
                            exit 1
                        fi
                    """
                    
                    // Ki·ªÉm tra Nginx container
                    sh """
                        if docker ps | grep -q ${NGINX_CONTAINER_NAME}; then
                            echo "‚úÖ Nginx container is running"
                        else
                            echo "‚ùå Nginx container failed to start"
                            docker logs ${NGINX_CONTAINER_NAME} || true
                            exit 1
                        fi
                    """
                    
                    // Ki·ªÉm tra qua Nginx reverse proxy (HTTP)
                    sh """
                        sleep 3
                        curl -f http://localhost/health || echo "‚ö†Ô∏è  Health check endpoint not available"
                    """
                    
                    // Ki·ªÉm tra trang ch·ªß qua Nginx (HTTP)
                    sh """
                        curl -f http://localhost/ || echo "‚ö†Ô∏è  Homepage check failed"
                    """
                    
                    // Ki·ªÉm tra HTTPS n·∫øu SSL enabled
                    if (SSL_ENABLED == 'true') {
                        sh """
                            sleep 2
                            curl -k -f https://localhost/health || echo "‚ö†Ô∏è  HTTPS health check endpoint not available"
                        """
                        
                        sh """
                            curl -k -f https://localhost/ || echo "‚ö†Ô∏è  HTTPS homepage check failed"
                        """
                        
                        echo "‚úÖ SSL/HTTPS is working"
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo 'üßπ Cleaning up old images...'
                    // X√≥a images c≈© (gi·ªØ l·∫°i 5 images g·∫ßn nh·∫•t) cho c·∫£ frontend v√† nginx
                    sh """
                        docker images ${IMAGE_NAME} --format '{{.ID}} {{.Tag}}' | \\
                        grep -v latest | \\
                        sort -k2 -n -r | \\
                        tail -n +6 | \\
                        awk '{print \$1}' | \\
                        xargs -r docker rmi || true
                        
                        docker images ${NGINX_IMAGE_NAME} --format '{{.ID}} {{.Tag}}' | \\
                        grep -v latest | \\
                        sort -k2 -n -r | \\
                        tail -n +6 | \\
                        awk '{print \$1}' | \\
                        xargs -r docker rmi || true
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            // C√≥ th·ªÉ th√™m notification ·ªü ƒë√¢y (email, Slack, etc.)
        }
        failure {
            echo '‚ùå Pipeline failed!'
            script {
                // Log container logs n·∫øu fail
                sh """
                    echo "=== Frontend Container Logs ==="
                    docker logs ${CONTAINER_NAME} || true
                    echo ""
                    echo "=== Nginx Container Logs ==="
                    docker logs ${NGINX_CONTAINER_NAME} || true
                """
            }
        }
        always {
            echo 'üìã Pipeline finished'
            // Cleanup workspace n·∫øu c·∫ßn
            // cleanWs()
        }
    }
}

