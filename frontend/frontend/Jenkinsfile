pipeline {
    agent any
    
    environment {
        // TÃªn image vÃ  container
        IMAGE_NAME = 'itworks-frontend'
        CONTAINER_NAME = 'itworks-frontend'
        NGINX_IMAGE_NAME = 'itworks-nginx'
        NGINX_CONTAINER_NAME = 'itworks-nginx'
        DOCKER_NETWORK = 'itworks-network'
        
        // Port mapping
        APP_PORT = '80'
        NGINX_HTTP_PORT = '80'
        NGINX_HTTPS_PORT = '443'
        
        // SSL Configuration
        // CÃ³ thá»ƒ override qua Jenkins parameters hoáº·c credentials
        DOMAIN = "${env.DOMAIN ?: 'itworks.dpdns.org'}"
        DOMAIN_EMAIL = "${env.DOMAIN_EMAIL ?: 'admin@itworks.dpdns.org'}"
        SSL_ENABLED = "${env.SSL_ENABLED ?: 'true'}"
        LETSENCRYPT_DIR = '/etc/letsencrypt'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Create Docker Network') {
            steps {
                script {
                    echo 'ðŸŒ Creating Docker network...'
                    sh """
                        docker network create ${DOCKER_NETWORK} 2>/dev/null || true
                    """
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo 'ðŸ”¨ Building Frontend Docker image...'
                    dir('frontend/frontend') {
                        // Build frontend image vá»›i tag
                        def imageTag = "${IMAGE_NAME}:${BUILD_NUMBER}"
                        def imageLatest = "${IMAGE_NAME}:latest"
                        
                        sh """
                            docker build -t ${imageTag} -t ${imageLatest} .
                        """
                        
                        echo "âœ… Frontend image built: ${imageTag}"
                    }
                }
            }
        }
        
        stage('Setup SSL') {
            when {
                expression { return SSL_ENABLED == 'true' }
            }
            steps {
                script {
                    echo "ðŸ”’ Setting up SSL for domain: ${DOMAIN}"
                    
                    // Kiá»ƒm tra quyá»n root (Jenkins user cáº§n cÃ³ quyá»n sudo)
                    sh """
                        # Kiá»ƒm tra certbot Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t chÆ°a
                        if ! command -v certbot &> /dev/null; then
                            echo "ðŸ“¦ Installing Certbot..."
                            sudo apt-get update -qq
                            sudo apt-get install -y -qq certbot
                        else
                            echo "âœ… Certbot Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
                        fi
                        
                        # Táº¡o thÆ° má»¥c cho certificates náº¿u chÆ°a cÃ³
                        sudo mkdir -p ${LETSENCRYPT_DIR}/live/${DOMAIN}
                        sudo mkdir -p /var/www/certbot
                        sudo chmod -R 755 ${LETSENCRYPT_DIR}
                    """
                    
                    // Kiá»ƒm tra certificate Ä‘Ã£ tá»“n táº¡i chÆ°a
                    def certExists = sh(
                        script: "sudo test -f ${LETSENCRYPT_DIR}/live/${DOMAIN}/fullchain.pem && echo 'exists' || echo 'not_exists'",
                        returnStdout: true
                    ).trim()
                    
                    if (certExists == 'not_exists') {
                        echo "ðŸ” Getting SSL certificate for ${DOMAIN}..."
                        // Táº¡m thá»i stop nginx Ä‘á»ƒ certbot cÃ³ thá»ƒ dÃ¹ng port 80
                        sh """
                            # Stop nginx container náº¿u Ä‘ang cháº¡y
                            docker stop ${NGINX_CONTAINER_NAME} || true
                            
                            # Láº¥y SSL certificate
                            sudo certbot certonly --standalone \\
                                -d ${DOMAIN} \\
                                -d www.${DOMAIN} \\
                                --non-interactive \\
                                --agree-tos \\
                                --email ${DOMAIN_EMAIL} \\
                                --preferred-challenges http \\
                                --keep-until-expiring || echo "âš ï¸  Certificate request failed, may already exist"
                        """
                    } else {
                        echo "âœ… SSL certificate Ä‘Ã£ tá»“n táº¡i, kiá»ƒm tra renewal..."
                        sh """
                            # Kiá»ƒm tra vÃ  renew náº¿u cáº§n
                            sudo certbot renew --quiet --no-self-upgrade || true
                        """
                    }
                    
                    // Cáº­p nháº­t nginx.conf Ä‘á»ƒ enable HTTPS
                    echo "ðŸ“ Updating Nginx configuration for SSL..."
                    dir('frontend/frontend/nginx') {
                        sh """
                            # Backup nginx.conf
                            cp nginx.conf nginx.conf.backup || true
                            
                            # Enable HTTPS server block
                            sed -i 's/# server {/server {/g' nginx.conf
                            sed -i 's/#     listen 443/    listen 443/g' nginx.conf
                            sed -i 's/#     server_name/    server_name/g' nginx.conf
                            sed -i 's/#     ssl_certificate/    ssl_certificate/g' nginx.conf
                            sed -i 's/#     ssl_certificate_key/    ssl_certificate_key/g' nginx.conf
                            sed -i 's/#     ssl_protocols/    ssl_protocols/g' nginx.conf
                            sed -i 's/#     ssl_ciphers/    ssl_ciphers/g' nginx.conf
                            sed -i 's/#     ssl_prefer_server_ciphers/    ssl_prefer_server_ciphers/g' nginx.conf
                            sed -i 's/#     ssl_session_cache/    ssl_session_cache/g' nginx.conf
                            sed -i 's/#     ssl_session_timeout/    ssl_session_timeout/g' nginx.conf
                            sed -i 's/#     add_header/    add_header/g' nginx.conf
                            sed -i 's/#     gzip/    gzip/g' nginx.conf
                            sed -i 's/#     proxy_set_header/    proxy_set_header/g' nginx.conf
                            sed -i 's/#     proxy_connect_timeout/    proxy_connect_timeout/g' nginx.conf
                            sed -i 's/#     proxy_send_timeout/    proxy_send_timeout/g' nginx.conf
                            sed -i 's/#     proxy_read_timeout/    proxy_read_timeout/g' nginx.conf
                            sed -i 's/#     location/    location/g' nginx.conf
                            sed -i 's/#         proxy_pass/        proxy_pass/g' nginx.conf
                            sed -i 's/#         proxy_http_version/        proxy_http_version/g' nginx.conf
                            sed -i 's/#         proxy_set_header/        proxy_set_header/g' nginx.conf
                            sed -i 's/#         expires/        expires/g' nginx.conf
                            sed -i 's/#         add_header/        add_header/g' nginx.conf
                            sed -i 's/# }/}/g' nginx.conf
                            
                            # Enable HTTP to HTTPS redirect
                            sed -i 's/# return 301 https/return 301 https/g' nginx.conf
                            
                            # Update domain name trong nginx.conf
                            sed -i "s/itworks.dpdns.org/${DOMAIN}/g" nginx.conf
                            sed -i "s/www.itworks.dpdns.org/www.${DOMAIN}/g" nginx.conf
                        """
                    }
                    
                    // Setup auto-renewal cron job
                    echo "ðŸ”„ Setting up SSL auto-renewal..."
                    sh """
                        # Táº¡o cron job Ä‘á»ƒ auto-renew SSL certificate
                        sudo bash -c 'cat > /etc/cron.d/certbot-renew-${NGINX_CONTAINER_NAME} <<EOF
# Auto-renew SSL certificate for ${DOMAIN}
0 3 * * * certbot renew --quiet --deploy-hook "docker restart ${NGINX_CONTAINER_NAME}" || true
EOF'
                        sudo chmod 0644 /etc/cron.d/certbot-renew-${NGINX_CONTAINER_NAME}
                    """
                    
                    echo "âœ… SSL setup completed!"
                }
            }
        }
        
        stage('Build Nginx Image') {
            steps {
                script {
                    echo 'ðŸ”¨ Building Nginx reverse proxy image...'
                    dir('frontend/frontend/nginx') {
                        // Build nginx image vá»›i tag
                        def nginxImageTag = "${NGINX_IMAGE_NAME}:${BUILD_NUMBER}"
                        def nginxImageLatest = "${NGINX_IMAGE_NAME}:latest"
                        
                        sh """
                            docker build -t ${nginxImageTag} -t ${nginxImageLatest} .
                        """
                        
                        echo "âœ… Nginx image built: ${nginxImageTag}"
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo 'ðŸ§ª Running tests...'
                    dir('frontend/frontend') {
                        // Cháº¡y tests trong container (optional)
                        // sh 'docker run --rm ${IMAGE_NAME}:${BUILD_NUMBER} npm test'
                        echo 'âš ï¸  Tests skipped (uncomment to enable)'
                    }
                }
            }
        }
        
        stage('Stop Old Containers') {
            steps {
                script {
                    echo 'ðŸ›‘ Stopping old containers if exists...'
                    sh """
                        docker stop ${CONTAINER_NAME} ${NGINX_CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} ${NGINX_CONTAINER_NAME} || true
                    """
                }
            }
        }
        
        stage('Deploy Frontend') {
            steps {
                script {
                    echo 'ðŸš€ Deploying Frontend container...'
                    // Frontend khÃ´ng cáº§n expose port ra ngoÃ i, chá»‰ cáº§n trong Docker network
                    // Nginx sáº½ proxy Ä‘áº¿n container nÃ y
                    sh """
                        docker run -d \\
                            --name ${CONTAINER_NAME} \\
                            --restart unless-stopped \\
                            --network ${DOCKER_NETWORK} \\
                            ${IMAGE_NAME}:${BUILD_NUMBER}
                    """
                }
            }
        }
        
        stage('Deploy Nginx') {
            steps {
                script {
                    echo 'ðŸš€ Deploying Nginx reverse proxy container...'
                    
                    // Náº¿u SSL Ä‘Æ°á»£c enable, mount SSL certificates
                    if (SSL_ENABLED == 'true') {
                        echo "ðŸ”’ Deploying Nginx with SSL certificates..."
                        sh """
                            docker run -d \\
                                --name ${NGINX_CONTAINER_NAME} \\
                                --restart unless-stopped \\
                                -p ${NGINX_HTTP_PORT}:80 \\
                                -p ${NGINX_HTTPS_PORT}:443 \\
                                -v ${LETSENCRYPT_DIR}:/etc/letsencrypt:ro \\
                                -v /var/www/certbot:/var/www/certbot:ro \\
                                --network ${DOCKER_NETWORK} \\
                                ${NGINX_IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    } else {
                        echo "ðŸŒ Deploying Nginx without SSL (HTTP only)..."
                        sh """
                            docker run -d \\
                                --name ${NGINX_CONTAINER_NAME} \\
                                --restart unless-stopped \\
                                -p ${NGINX_HTTP_PORT}:80 \\
                                -p ${NGINX_HTTPS_PORT}:443 \\
                                --network ${DOCKER_NETWORK} \\
                                ${NGINX_IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'ðŸ¥ Waiting for application to start...'
                    sleep(time: 5, unit: 'SECONDS')
                    
                    // Kiá»ƒm tra container cÃ³ cháº¡y khÃ´ng
                    sh """
                        if docker ps | grep -q ${CONTAINER_NAME}; then
                            echo "âœ… Container is running"
                        else
                            echo "âŒ Container failed to start"
                            docker logs ${CONTAINER_NAME}
                            exit 1
                        fi
                    """
                    
                    // Kiá»ƒm tra Nginx container
                    sh """
                        if docker ps | grep -q ${NGINX_CONTAINER_NAME}; then
                            echo "âœ… Nginx container is running"
                        else
                            echo "âŒ Nginx container failed to start"
                            docker logs ${NGINX_CONTAINER_NAME} || true
                            exit 1
                        fi
                    """
                    
                    // Kiá»ƒm tra qua Nginx reverse proxy
                    sh """
                        sleep 3
                        curl -f http://localhost/health || echo "âš ï¸  Health check endpoint not available"
                    """
                    
                    // Kiá»ƒm tra trang chá»§ qua Nginx (HTTP)
                    sh """
                        curl -f http://localhost/ || echo "âš ï¸  Homepage check failed"
                    """
                    
                    // Kiá»ƒm tra HTTPS náº¿u SSL Ä‘Æ°á»£c enable
                    if (SSL_ENABLED == 'true') {
                        sh """
                            echo "ðŸ”’ Testing HTTPS connection..."
                            sleep 2
                            curl -k -f https://localhost/ || echo "âš ï¸  HTTPS check failed (certificate may be self-signed)"
                            
                            # Kiá»ƒm tra SSL certificate
                            if [ -f ${LETSENCRYPT_DIR}/live/${DOMAIN}/fullchain.pem ]; then
                                echo "âœ… SSL certificate found"
                                sudo openssl x509 -in ${LETSENCRYPT_DIR}/live/${DOMAIN}/fullchain.pem -noout -dates || true
                            else
                                echo "âš ï¸  SSL certificate not found"
                            fi
                        """
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo 'ðŸ§¹ Cleaning up old images...'
                    // XÃ³a images cÅ© (giá»¯ láº¡i 5 images gáº§n nháº¥t) cho cáº£ frontend vÃ  nginx
                    sh """
                        docker images ${IMAGE_NAME} --format '{{.ID}} {{.Tag}}' | \\
                        grep -v latest | \\
                        sort -k2 -n -r | \\
                        tail -n +6 | \\
                        awk '{print \$1}' | \\
                        xargs -r docker rmi || true
                        
                        docker images ${NGINX_IMAGE_NAME} --format '{{.ID}} {{.Tag}}' | \\
                        grep -v latest | \\
                        sort -k2 -n -r | \\
                        tail -n +6 | \\
                        awk '{print \$1}' | \\
                        xargs -r docker rmi || true
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            // CÃ³ thá»ƒ thÃªm notification á»Ÿ Ä‘Ã¢y (email, Slack, etc.)
        }
        failure {
            echo 'âŒ Pipeline failed!'
            script {
                // Log container logs náº¿u fail
                sh """
                    docker logs ${CONTAINER_NAME} || true
                """
            }
        }
        always {
            echo 'ðŸ“‹ Pipeline finished'
            // Cleanup workspace náº¿u cáº§n
            // cleanWs()
        }
    }
}

